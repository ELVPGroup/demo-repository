// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum OrderStatus {
  PENDING // å¾…å‘è´§
  SHIPPED // è¿è¾“ä¸­
  COMPLETED // å·²å®Œæˆ
  CANCELED // å·²å–æ¶ˆ
}

enum ShippingStatus {
  PENDING // å¾…å‘è´§
  PACKING // å·²æ½æ”¶
  SHIPPED // è¿è¾“ä¸­
  IN_TRANSIT // æ´¾é€ä¸­
  DELIVERED // å·²ç­¾æ”¶
  CANCELED // å·²å–æ¶ˆ
}

model User {
  // SERIAL - ğŸ”‘ PK, not null, unique, autoincrement
  userId    Int           @id @default(autoincrement()) @map("userId")
  name      String        @db.VarChar(255)
  phone     String        @unique @db.VarChar(20)
  password  String        @db.VarChar(255)
  addresses AddressInfo[] @relation("UserAddresses")
  orders    Order[]

  // Default address foreign key
  defaultAddressId Int?         @map("defaultAddressId")
  defaultAddress   AddressInfo? @relation("UserDefaultAddress", fields: [defaultAddressId], references: [addressInfoId], onDelete: SetNull)

  @@map("users")
}

model Merchant {
  // SERIAL - ğŸ”‘ PK, not null, unique, autoincrement
  merchantId         Int                 @id @default(autoincrement()) @map("merchantId")
  name               String              @db.VarChar(255)
  phone              String              @unique @db.VarChar(20)
  password           String              @db.VarChar(255)
  addresses          AddressInfo[]       @relation("MerchantAddresses")
  orders             Order[]
  // ä¸€ä¸ªå•†å®¶å¯¹åº”å¤šä¸ªå•†å“
  products           Product[]
  // ä¸€ä¸ªå•†å®¶å¯¹åº”ä¸€ä¸ªé…é€èŒƒå›´
  deliveryArea       DeliveryArea?
  // å¤šä¸ªå•†å®¶å¯ä»¥è®¾ç½®å¤šä¸ªç‰©æµ provider
  logisticsProviders LogisticsProvider[]

  // Default address foreign key
  defaultAddressId Int?         @map("defaultAddressId")
  // å¤šä¸ªå•†å®¶å¯ä»¥è®¾ç½®å¤šä¸ªé»˜è®¤åœ°å€
  defaultAddress   AddressInfo? @relation("MerchantDefaultAddress", fields: [defaultAddressId], references: [addressInfoId], onDelete: SetNull)

  @@map("merchants")
}

model AddressInfo {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  addressInfoId Int    @id @default(autoincrement()) @map("addressInfoId")
  name          String @db.VarChar(255)
  phone         String @db.VarChar(20)
  address       String @db.VarChar(255)
  // location (longitude, latitude)
  longitude     Float  @db.DoublePrecision
  latitude      Float  @db.DoublePrecision

  // Foreign Keys
  userId     Int?      @map("userId")
  user       User?     @relation("UserAddresses", fields: [userId], references: [userId])
  merchantId Int?      @map("merchantId")
  merchant   Merchant? @relation("MerchantAddresses", fields: [merchantId], references: [merchantId])

  // é»˜è®¤åœ°å€åå‘å¼•ç”¨ï¼ˆä¸€ä¸ªåœ°å€å¯ä½œä¸ºå¤šä¸ªç”¨æˆ·/å•†å®¶çš„é»˜è®¤åœ°å€ï¼‰
  usersUsingAsDefault     User[]     @relation("UserDefaultAddress")
  merchantsUsingAsDefault Merchant[] @relation("MerchantDefaultAddress")

  // ä¸€ä¸ªåœ°å€å¯ä½œä¸ºå¤šä¸ªè®¢å•çš„å‘è´§åœ°å€
  shippingFromOrders OrderDetail[] @relation("ShippingFromAddress") // å‘è´§åœ°å€
  // ä¸€ä¸ªåœ°å€å¯ä½œä¸ºå¤šä¸ªè®¢å•çš„æ”¶è´§åœ°å€
  shippingToOrders   OrderDetail[] @relation("ShippingToAddress") // æ”¶è´§åœ°å€

  @@map("addressInfo")
}

model Product {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  productId   Int     @id @default(autoincrement()) @map("productId")
  name        String  @db.VarChar(255)
  description String? @db.Text
  price       Decimal @db.Decimal(10, 2)
  amount      Int
  // å•†å“å›¾ç‰‡é“¾æ¥
  imageUrl    String? @db.VarChar(255)

  // Foreign Key - å•†å“æ‰€å±å•†å®¶ï¼ˆä¸€å¯¹å¤šï¼‰
  merchantId Int      @map("merchantId")
  merchant   Merchant @relation(fields: [merchantId], references: [merchantId])

  // ä¸€ä¸ªå•†å“å¯è¢«å¤šä¸ªè®¢å•é¡¹å¼•ç”¨
  orderItems OrderItem[]

  @@map("products")
}

model Order {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  orderId    Int         @id @default(autoincrement()) @map("orderId")
  status     OrderStatus @default(PENDING)
  // TIMESTAMPTZ
  createdAt  DateTime    @default(now()) @db.Timestamptz(6)
  totalPrice Decimal     @default(0) @db.Decimal(10, 2)

  // Foreign Keys
  userId     Int?         @map("userId")
  user       User?        @relation(fields: [userId], references: [userId])
  merchantId Int?         @map("merchantId")
  merchant   Merchant?    @relation(fields: [merchantId], references: [merchantId])
  // ä¸€ä¸ªè®¢å•åŒ…å«å¤šä¸ªè®¢å•é¡¹
  orderItems OrderItem[]
  // ä¸€ä¸ªè®¢å•å¯¹åº”ä¸€ä¸ªè®¢å•è¯¦æƒ…
  detail     OrderDetail?

  @@map("orders")
}

model OrderItem {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  orderItemId Int @id @default(autoincrement()) @map("orderItemId")
  quantity    Int @map("quantity")

  // Foreign Keys
  orderId   Int     @map("orderId")
  order     Order   @relation(fields: [orderId], references: [orderId])
  productId Int     @map("productId")
  product   Product @relation(fields: [productId], references: [productId])

  @@unique([orderId, productId]) // ä¸€ä¸ªè®¢å•é¡¹åªèƒ½å¯¹åº”ä¸€ä¸ªå•†å“
  @@map("orderItems")
}

model OrderDetail {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement (ä½œä¸ºä¸»é”®/å¤–é”®)
  // è®¢å•è¯¦æƒ…ä¸è®¢å•ä¸€ä¸€å¯¹åº”
  orderId Int   @id @map("orderId")
  order   Order @relation(fields: [orderId], references: [orderId])

  // Foreign Keys
  // å¤šä¸ªè®¢å•è¯¦æƒ…å¯æŒ‡å‘åŒä¸€å‘è´§åœ°å€
  addressFromId Int         @map("addressFromId")
  addressFrom   AddressInfo @relation("ShippingFromAddress", fields: [addressFromId], references: [addressInfoId])

  // å¤šä¸ªè®¢å•è¯¦æƒ…å¯æŒ‡å‘åŒä¸€æ”¶è´§åœ°å€
  addressToId Int         @map("addressToId")
  addressTo   AddressInfo @relation("ShippingToAddress", fields: [addressToId], references: [addressInfoId])

  // ä¸€ä¸ªè®¢å•è¯¦æƒ…æœ‰å¤šä¸ªæ—¶é—´çº¿æ¡ç›®
  timelineItems TimelineItem[]

  @@map("orderDetail")
}

model TimelineItem {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  id Int @id @default(autoincrement())

  // Foreign Key
  // å¤šä¸ªæ—¶é—´çº¿æ¡ç›®å±äºä¸€ä¸ªè®¢å•è¯¦æƒ…
  orderId     Int         @map("orderId")
  orderDetail OrderDetail @relation(fields: [orderId], references: [orderId])

  shippingStatus ShippingStatus @default(PENDING)
  time           DateTime       @default(now()) @db.Timestamptz(6)
  description    String?        @map("description") @db.Text

  @@map("timelineItems")
}

model DeliveryArea {
  // center point (longitude, latitude)
  longitude Float   @db.DoublePrecision
  latitude  Float   @db.DoublePrecision
  radius    Decimal @db.Decimal

  // Foreign Key
  // é€šè¿‡å”¯ä¸€ merchantId å…³è”ä¸€ä¸ªå•†å®¶
  merchantId Int      @map("merchantId")
  merchant   Merchant @relation(fields: [merchantId], references: [merchantId])

  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  @@id([merchantId])
  @@map("deliveryArea")
}

model LogisticsProvider {
  // INTEGER - ğŸ”‘ PK, not null, unique, autoincrement
  logisticsId Int    @id @default(autoincrement()) @map("logisticsId")
  name        String @unique @db.VarChar(255)
  speed       Float  @db.DoublePrecision

  merchants Merchant[]

  @@map("logisticsProviders")
}
